<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>blitzpython: /root/google/blitzpython/gamemodel.py Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>/root/google/blitzpython/gamemodel.py</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">#</span>
<a name="l00002"></a>00002 <span class="comment"># Copyright 2007 Google Inc.</span>
<a name="l00003"></a>00003 <span class="comment">#</span>
<a name="l00004"></a>00004 <span class="comment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="l00005"></a>00005 <span class="comment"># you may not use this file except in compliance with the License.</span>
<a name="l00006"></a>00006 <span class="comment"># You may obtain a copy of the License at</span>
<a name="l00007"></a>00007 <span class="comment">#</span>
<a name="l00008"></a>00008 <span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00009"></a>00009 <span class="comment">#</span>
<a name="l00010"></a>00010 <span class="comment"># Unless required by applicable law or agreed to in writing, software</span>
<a name="l00011"></a>00011 <span class="comment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="l00012"></a>00012 <span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00013"></a>00013 <span class="comment"># See the License for the specific language governing permissions and</span>
<a name="l00014"></a>00014 <span class="comment"># limitations under the License.</span>
<a name="l00015"></a>00015 <span class="comment">#</span>
<a name="l00016"></a>00016 <span class="keyword">import</span> time
<a name="l00017"></a>00017 <span class="keyword">import</span> sys
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="keyword">from</span> google.appengine.api <span class="keyword">import</span> users
<a name="l00020"></a>00020 <span class="keyword">from</span> google.appengine.ext <span class="keyword">import</span> db
<a name="l00021"></a>00021 
<a name="l00022"></a><a class="code" href="classgamemodel_1_1_game.html">00022</a> <span class="keyword">class </span><a class="code" href="classgamemodel_1_1_game.html">Game</a>(db.Model):
<a name="l00023"></a>00023   <span class="stringliteral">&quot;&quot;&quot; Our DB representation of a game - includes the type of the game, the</span>
<a name="l00024"></a>00024 <span class="stringliteral">      players, public visibility, etc</span>
<a name="l00025"></a>00025 <span class="stringliteral">  &quot;&quot;&quot;</span>
<a name="l00026"></a>00026   <span class="comment"># Player 1 is the creator of the game</span>
<a name="l00027"></a>00027   player1 = db.UserProperty(required=<span class="keyword">True</span>)
<a name="l00028"></a>00028 
<a name="l00029"></a>00029   <span class="comment"># Player 1 color (WHITE or BLACK)</span>
<a name="l00030"></a>00030   player1_color = db.IntegerProperty(required=<span class="keyword">True</span>)
<a name="l00031"></a>00031 
<a name="l00032"></a>00032   <span class="comment"># The amount of time each player has remaining</span>
<a name="l00033"></a>00033   player1_time = db.IntegerProperty()
<a name="l00034"></a>00034   player2_time = db.IntegerProperty()
<a name="l00035"></a>00035 
<a name="l00036"></a>00036   <span class="comment"># If invitee is empty, then this is a publicly joinable game</span>
<a name="l00037"></a>00037   <span class="comment"># (GAME_STATUS_OPEN). Otherwise, if invitee is non-empty, then this is an</span>
<a name="l00038"></a>00038   <span class="comment"># invite-only game and only users with that email can join it.</span>
<a name="l00039"></a>00039   invitee = db.StringProperty()
<a name="l00040"></a>00040 
<a name="l00041"></a>00041   <span class="comment"># The person who has joined the game</span>
<a name="l00042"></a>00042   player2 = db.UserProperty()
<a name="l00043"></a>00043 
<a name="l00044"></a>00044   <span class="comment"># If True, anyone can view this game</span>
<a name="l00045"></a>00045   public = db.BooleanProperty(default=<span class="keyword">False</span>)
<a name="l00046"></a>00046 
<a name="l00047"></a>00047   <span class="comment"># Description of the status of this game. See the GAME_STATUS values</span>
<a name="l00048"></a>00048   status = db.IntegerProperty(required=<span class="keyword">True</span>)
<a name="l00049"></a>00049 
<a name="l00050"></a>00050   <span class="comment"># The index of the victor (1 = player 1, 2 = player 2, 0 = draw)</span>
<a name="l00051"></a>00051   victor = db.IntegerProperty()
<a name="l00052"></a>00052 
<a name="l00053"></a>00053   <span class="comment"># Various strings are valid: chess, blitz-5, blitz-10</span>
<a name="l00054"></a>00054   game_type = db.StringProperty(required=<span class="keyword">True</span>)
<a name="l00055"></a>00055   
<a name="l00056"></a>00056   <span class="comment"># The data for this game</span>
<a name="l00057"></a>00057   game_data = db.StringListProperty()
<a name="l00058"></a>00058 
<a name="l00059"></a>00059   <span class="comment"># timestamp is updated on create</span>
<a name="l00060"></a>00060   created = db.DateTimeProperty(auto_now_add=<span class="keyword">True</span>)
<a name="l00061"></a>00061 
<a name="l00062"></a>00062   <span class="comment"># timestamp is updated on every refresh</span>
<a name="l00063"></a>00063   last_modified = db.DateTimeProperty(auto_now=<span class="keyword">True</span>)
<a name="l00064"></a>00064 
<a name="l00065"></a><a class="code" href="classgamemodel_1_1_game.html#ac89de8eeac6f1ca37557ccc63826712a">00065</a>   <span class="keyword">def </span><a class="code" href="classgamemodel_1_1_game.html#ac89de8eeac6f1ca37557ccc63826712a">get_creation_time</a>(self):
<a name="l00066"></a>00066     <span class="stringliteral">&quot;&quot;&quot; Returns the creation time, rendered as a string. We could do timezone</span>
<a name="l00067"></a>00067 <span class="stringliteral">        math, but for now (because it&apos;s easy) we&apos;ll just emit a time delta</span>
<a name="l00068"></a>00068 <span class="stringliteral">        (e.g. &quot;15 minutes ago&quot;)</span>
<a name="l00069"></a>00069 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00070"></a>00070     elapsed = time.time() - time.mktime(self.<a class="code" href="classgamemodel_1_1_game.html#a34f2571ecfec0169faa3ee9d6f3a496c">created</a>.timetuple())
<a name="l00071"></a>00071     <span class="keywordflow">return</span> relative_string(elapsed)
<a name="l00072"></a>00072 
<a name="l00073"></a><a class="code" href="classgamemodel_1_1_game.html#af5b44876090f890a856cfd2de8076598">00073</a>   <span class="keyword">def </span><a class="code" href="classgamemodel_1_1_game.html#af5b44876090f890a856cfd2de8076598">get_last_modified</a>(self):
<a name="l00074"></a>00074     <span class="stringliteral">&quot;&quot;&quot; Returns the last modification date as a reasonably formatted string &quot;&quot;&quot;</span>
<a name="l00075"></a>00075     elapsed = time.time() - time.mktime(self.<a class="code" href="classgamemodel_1_1_game.html#a567c7c49ceb736bee54507460af7628c">last_modified</a>.timetuple())
<a name="l00076"></a>00076     <span class="keywordflow">return</span> relative_string(elapsed)
<a name="l00077"></a>00077 
<a name="l00078"></a><a class="code" href="classgamemodel_1_1_game.html#a22dcc2f02cf915c72d61afc05ab7bdc9">00078</a>   <span class="keyword">def </span><a class="code" href="classgamemodel_1_1_game.html#a22dcc2f02cf915c72d61afc05ab7bdc9">get_color_as_string</a>(self):
<a name="l00079"></a>00079     <span class="stringliteral">&quot;&quot;&quot; return white/black based on which player the user is &quot;&quot;&quot;</span>
<a name="l00080"></a>00080     color = self.<a class="code" href="classgamemodel_1_1_game.html#ade58245c722712b13735856c285841b9">get_user_color</a>(users.GetCurrentUser())
<a name="l00081"></a>00081     <span class="keywordflow">return</span> <span class="stringliteral">&quot;White&quot;</span> <span class="keywordflow">if</span> color == WHITE <span class="keywordflow">else</span> <span class="stringliteral">&quot;Black&quot;</span>
<a name="l00082"></a>00082 
<a name="l00083"></a><a class="code" href="classgamemodel_1_1_game.html#ade58245c722712b13735856c285841b9">00083</a>   <span class="keyword">def </span><a class="code" href="classgamemodel_1_1_game.html#ade58245c722712b13735856c285841b9">get_user_color</a>(self, user):
<a name="l00084"></a>00084     <span class="stringliteral">&quot;&quot;&quot; Return WHITE/BLACk based on the color of player 1, and whether the user</span>
<a name="l00085"></a>00085 <span class="stringliteral">        is player 1 or not</span>
<a name="l00086"></a>00086 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00087"></a>00087     <span class="keywordflow">if</span> (user == self.<a class="code" href="classgamemodel_1_1_game.html#af7358b6e0c290bb81c27a433b2f18c5f">player1</a>):
<a name="l00088"></a>00088       <span class="keywordflow">return</span> self.<a class="code" href="classgamemodel_1_1_game.html#ace14db55e14eb29ab455a0dfc040307d">player1_color</a>
<a name="l00089"></a>00089     <span class="keywordflow">else</span>:
<a name="l00090"></a>00090       <span class="keywordflow">return</span> BLACK - self.<a class="code" href="classgamemodel_1_1_game.html#ace14db55e14eb29ab455a0dfc040307d">player1_color</a>
<a name="l00091"></a>00091 
<a name="l00092"></a>00092   <span class="keyword">def </span>get_opposing_player(self):
<a name="l00093"></a>00093     user = users.GetCurrentUser()
<a name="l00094"></a>00094     <span class="keywordflow">if</span> user == self.<a class="code" href="classgamemodel_1_1_game.html#af7358b6e0c290bb81c27a433b2f18c5f">player1</a>:
<a name="l00095"></a>00095       <span class="keywordflow">return</span> self.<a class="code" href="classgamemodel_1_1_game.html#a46570b6dbd96a0a2855b9140af8a4edd">player2</a>
<a name="l00096"></a>00096     <span class="keywordflow">else</span>:
<a name="l00097"></a>00097       <span class="keywordflow">return</span> self.<a class="code" href="classgamemodel_1_1_game.html#af7358b6e0c290bb81c27a433b2f18c5f">player1</a>
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 
<a name="l00100"></a><a class="code" href="classgamemodel_1_1_game.html#af9aec96b63f43d42d554e093de46c2da">00100</a>   <span class="keyword">def </span><a class="code" href="classgamemodel_1_1_game.html#af9aec96b63f43d42d554e093de46c2da">user_can_modify</a>(self, user):
<a name="l00101"></a>00101     <span class="stringliteral">&quot;&quot;&quot; Returns true if the user can modify this game (user is a participant,</span>
<a name="l00102"></a>00102 <span class="stringliteral">        or an invitee, or the game is still open</span>
<a name="l00103"></a>00103 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00104"></a>00104     <span class="keywordflow">return</span> self.<a class="code" href="classgamemodel_1_1_game.html#a4690b578fba825b6922070c525eed257">user_is_participant</a>(user) <span class="keywordflow">or</span> self.<a class="code" href="classgamemodel_1_1_game.html#ad7843c85abee4764c9e717a8db8cb3a5">status</a> == GAME_STATUS_OPEN
<a name="l00105"></a>00105 
<a name="l00106"></a><a class="code" href="classgamemodel_1_1_game.html#a4690b578fba825b6922070c525eed257">00106</a>   <span class="keyword">def </span><a class="code" href="classgamemodel_1_1_game.html#a4690b578fba825b6922070c525eed257">user_is_participant</a>(self, user):
<a name="l00107"></a>00107     <span class="stringliteral">&quot;&quot;&quot; Returns true if the user is a participant - i.e. he&apos;s either the</span>
<a name="l00108"></a>00108 <span class="stringliteral">        creator, the opponent, or an invitee</span>
<a name="l00109"></a>00109 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00110"></a>00110     <span class="keywordflow">return</span> (user == self.<a class="code" href="classgamemodel_1_1_game.html#af7358b6e0c290bb81c27a433b2f18c5f">player1</a> <span class="keywordflow">or</span> user == self.<a class="code" href="classgamemodel_1_1_game.html#a46570b6dbd96a0a2855b9140af8a4edd">player2</a> <span class="keywordflow">or</span>
<a name="l00111"></a>00111             (self.<a class="code" href="classgamemodel_1_1_game.html#ad7843c85abee4764c9e717a8db8cb3a5">status</a> == GAME_STATUS_INVITED <span class="keywordflow">and</span>
<a name="l00112"></a>00112              user.email() == self.<a class="code" href="classgamemodel_1_1_game.html#a7a15b5c1629b25d4ac438cca2ff8208d">invitee</a>))
<a name="l00113"></a>00113 
<a name="l00114"></a>00114   <span class="keyword">def </span>user_can_view(self, user):
<a name="l00115"></a>00115     <span class="keywordflow">return</span> self.<a class="code" href="classgamemodel_1_1_game.html#a7043806e68c55c05d18ba865749448a7">public</a> <span class="keywordflow">or</span> self.<a class="code" href="classgamemodel_1_1_game.html#af9aec96b63f43d42d554e093de46c2da">user_can_modify</a>(user)
<a name="l00116"></a>00116 
<a name="l00117"></a><a class="code" href="classgamemodel_1_1_game.html#aa5152a042338ea29555f11041ee6e330">00117</a>   <span class="keyword">def </span><a class="code" href="classgamemodel_1_1_game.html#aa5152a042338ea29555f11041ee6e330">to_dict</a>(self, user):
<a name="l00118"></a>00118     <span class="stringliteral">&quot;&quot;&quot; Converts a game object to a dict with the following properties for</span>
<a name="l00119"></a>00119 <span class="stringliteral">        ease of json-ification:</span>
<a name="l00120"></a>00120 <span class="stringliteral">            {&apos;creator&apos;: &quot;player 1&quot;,    // The nickname for player 1</span>
<a name="l00121"></a>00121 <span class="stringliteral">             &apos;opponent&apos;: &quot;player 2&quot;,   // Omitted if game is open/joinable</span>
<a name="l00122"></a>00122 <span class="stringliteral">             &apos;creator_color&apos;: 0/1      // 0 = white, 1 = black</span>
<a name="l00123"></a>00123 <span class="stringliteral">             &apos;time_limit&apos;: 5,          // Currently only 5 or 10 is supported,</span>
<a name="l00124"></a>00124 <span class="stringliteral">                                       //   or omitted if untimed game</span>
<a name="l00125"></a>00125 <span class="stringliteral">             &apos;player1_time&apos;: 1234,     // Time bank in msecs, omitted if untimed</span>
<a name="l00126"></a>00126 <span class="stringliteral">             &apos;player2_time&apos;: 5678,     // Time bank in msecs, omitted if untimed</span>
<a name="l00127"></a>00127 <span class="stringliteral">             &apos;is_creator&apos; : true       // True if the player is the game creator</span>
<a name="l00128"></a>00128 <span class="stringliteral">                                       //   (e.g. player == player1)</span>
<a name="l00129"></a>00129 <span class="stringliteral">             &apos;is_invitee&apos;: true,       // present if user is the invitee and</span>
<a name="l00130"></a>00130 <span class="stringliteral">                                       //   status=GAME_STATUS_INVITED</span>
<a name="l00131"></a>00131 <span class="stringliteral">             &apos;is_participant&apos;: true,   // omitted if user not a participant</span>
<a name="l00132"></a>00132 <span class="stringliteral">             &apos;status&apos;: 0/1/2/3         // open, invited, active, complete</span>
<a name="l00133"></a>00133 <span class="stringliteral">             &apos;victor&apos;: 0/1/2           // draw, player1, player2</span>
<a name="l00134"></a>00134 <span class="stringliteral">             &apos;can_delete&apos; : true,      // true if &apos;is_participant&apos; and # </span>
<a name="l00135"></a>00135 <span class="stringliteral">                                       // moves &lt; 2</span>
<a name="l00136"></a>00136 <span class="stringliteral">             &apos;whose_turn&apos; : 0/1        // 0 = white, 1 = black</span>
<a name="l00137"></a>00137 <span class="stringliteral">            }</span>
<a name="l00138"></a>00138 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00139"></a>00139     result = {}
<a name="l00140"></a>00140     result[<span class="stringliteral">&apos;creator&apos;</span>] = self.<a class="code" href="classgamemodel_1_1_game.html#af7358b6e0c290bb81c27a433b2f18c5f">player1</a>.nickname()
<a name="l00141"></a>00141     result[<span class="stringliteral">&apos;creator_color&apos;</span>] = self.<a class="code" href="classgamemodel_1_1_game.html#ace14db55e14eb29ab455a0dfc040307d">player1_color</a>
<a name="l00142"></a>00142     result[<span class="stringliteral">&apos;status&apos;</span>] = self.<a class="code" href="classgamemodel_1_1_game.html#ad7843c85abee4764c9e717a8db8cb3a5">status</a>
<a name="l00143"></a>00143     result[<span class="stringliteral">&apos;key&apos;</span>] = str(self.key())
<a name="l00144"></a>00144 
<a name="l00145"></a>00145     <span class="comment"># Set the opponent to the appropriate value. We send nothing down if this</span>
<a name="l00146"></a>00146     <span class="comment"># is an unclaimed open game</span>
<a name="l00147"></a>00147     <span class="keywordflow">if</span> self.<a class="code" href="classgamemodel_1_1_game.html#ad7843c85abee4764c9e717a8db8cb3a5">status</a> &gt;= GAME_STATUS_ACTIVE:
<a name="l00148"></a>00148       <span class="comment"># Game is active or completed</span>
<a name="l00149"></a>00149       result[<span class="stringliteral">&apos;opponent&apos;</span>] = self.<a class="code" href="classgamemodel_1_1_game.html#a46570b6dbd96a0a2855b9140af8a4edd">player2</a>.nickname()
<a name="l00150"></a>00150     <span class="keywordflow">elif</span> self.<a class="code" href="classgamemodel_1_1_game.html#ad7843c85abee4764c9e717a8db8cb3a5">status</a> == GAME_STATUS_INVITED:
<a name="l00151"></a>00151       <span class="keywordflow">if</span> self.<a class="code" href="classgamemodel_1_1_game.html#a46570b6dbd96a0a2855b9140af8a4edd">player2</a>:
<a name="l00152"></a>00152         result[<span class="stringliteral">&apos;opponent&apos;</span>] = self.<a class="code" href="classgamemodel_1_1_game.html#a46570b6dbd96a0a2855b9140af8a4edd">player2</a>.nickname()
<a name="l00153"></a>00153       <span class="keywordflow">else</span>:
<a name="l00154"></a>00154         result[<span class="stringliteral">&apos;opponent&apos;</span>] = self.<a class="code" href="classgamemodel_1_1_game.html#a7a15b5c1629b25d4ac438cca2ff8208d">invitee</a>
<a name="l00155"></a>00155 
<a name="l00156"></a>00156     <span class="comment"># Send down the time limit appropriate to the game type</span>
<a name="l00157"></a>00157     <span class="keywordflow">if</span> self.<a class="code" href="classgamemodel_1_1_game.html#a37d7d5da1ec3e0480c651c91f41b0d79">game_type</a> == GAME_TYPE_BLITZ_5:
<a name="l00158"></a>00158       result[<span class="stringliteral">&apos;time_limit&apos;</span>] = 5
<a name="l00159"></a>00159     <span class="keywordflow">elif</span> self.<a class="code" href="classgamemodel_1_1_game.html#a37d7d5da1ec3e0480c651c91f41b0d79">game_type</a> == GAME_TYPE_BLITZ_10:
<a name="l00160"></a>00160       result[<span class="stringliteral">&apos;time_limit&apos;</span>] = 10
<a name="l00161"></a>00161 
<a name="l00162"></a>00162     <span class="comment"># If the user is a participant, send down information about their </span>
<a name="l00163"></a>00163     <span class="comment"># permissions and status</span>
<a name="l00164"></a>00164     <span class="keywordflow">if</span> self.<a class="code" href="classgamemodel_1_1_game.html#a4690b578fba825b6922070c525eed257">user_is_participant</a>(user):
<a name="l00165"></a>00165       result[<span class="stringliteral">&apos;is_participant&apos;</span>] = <span class="keyword">True</span>
<a name="l00166"></a>00166       result[<span class="stringliteral">&apos;can_delete&apos;</span>] = len(self.<a class="code" href="classgamemodel_1_1_game.html#a274420c1f69b6ebcc1de1fadee5ff023">game_data</a>) &lt;= 2
<a name="l00167"></a>00167       <span class="keywordflow">if</span> user == self.<a class="code" href="classgamemodel_1_1_game.html#af7358b6e0c290bb81c27a433b2f18c5f">player1</a>:
<a name="l00168"></a>00168         result[<span class="stringliteral">&apos;is_creator&apos;</span>] = <span class="keyword">True</span>
<a name="l00169"></a>00169       <span class="keywordflow">elif</span> self.<a class="code" href="classgamemodel_1_1_game.html#ad7843c85abee4764c9e717a8db8cb3a5">status</a> == GAME_STATUS_INVITED:
<a name="l00170"></a>00170         result[<span class="stringliteral">&apos;is_invitee&apos;</span>] = <span class="keyword">True</span>
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     <span class="comment"># If this game has a time limit, send down the time status of each player</span>
<a name="l00173"></a>00173     <span class="keywordflow">if</span> <span class="stringliteral">&apos;time_limit&apos;</span> <span class="keywordflow">in</span> result:
<a name="l00174"></a>00174       result[<span class="stringliteral">&apos;player1_time&apos;</span>] = self.<a class="code" href="classgamemodel_1_1_game.html#affbe058762ace7df766dcac5270832d8">player1_time</a>
<a name="l00175"></a>00175       result[<span class="stringliteral">&apos;player2_time&apos;</span>] = self.<a class="code" href="classgamemodel_1_1_game.html#a21575be4fd330e198955fe7c0f1803cf">player2_time</a>
<a name="l00176"></a>00176 
<a name="l00177"></a>00177     <span class="keywordflow">if</span> self.<a class="code" href="classgamemodel_1_1_game.html#ad7843c85abee4764c9e717a8db8cb3a5">status</a> == GAME_STATUS_COMPLETE:
<a name="l00178"></a>00178       result[<span class="stringliteral">&apos;victor&apos;</span>] = self.<a class="code" href="classgamemodel_1_1_game.html#a7176ec1e9d8c2493c12ee92a1a132e6f">victor</a>
<a name="l00179"></a>00179     <span class="keywordflow">else</span>:
<a name="l00180"></a>00180       result[<span class="stringliteral">&apos;whose_turn&apos;</span>] = self.<a class="code" href="classgamemodel_1_1_game.html#a2186f09a381bb87968495203dce889d7">whose_turn</a>()
<a name="l00181"></a>00181 
<a name="l00182"></a>00182     <span class="keywordflow">return</span> result
<a name="l00183"></a>00183 
<a name="l00184"></a><a class="code" href="classgamemodel_1_1_game.html#abe52b977c101e59f342489ed18140819">00184</a>   <span class="keyword">def </span><a class="code" href="classgamemodel_1_1_game.html#abe52b977c101e59f342489ed18140819">update</a>(self, user, move=None, timer=None, victor=None):
<a name="l00185"></a>00185     <span class="stringliteral">&quot;&quot;&quot; Adds a move if the user can move.</span>
<a name="l00186"></a>00186 <span class="stringliteral">        Returns true if move was accepted - we have logic to ignore duplicate</span>
<a name="l00187"></a>00187 <span class="stringliteral">        moves, as that can happen sometimes if the server response is lost and</span>
<a name="l00188"></a>00188 <span class="stringliteral">        the client resubmits</span>
<a name="l00189"></a>00189 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00190"></a>00190     <span class="keywordflow">return</span> db.run_in_transaction(txn_update, self.key(), user, move, timer, victor)
<a name="l00191"></a>00191 
<a name="l00192"></a><a class="code" href="classgamemodel_1_1_game.html#a427144263b022aff6d184fa3ae8a8e31">00192</a>   <span class="keyword">def </span><a class="code" href="classgamemodel_1_1_game.html#a427144263b022aff6d184fa3ae8a8e31">is_victory</a>(self, user):
<a name="l00193"></a>00193     <span class="stringliteral">&quot;&quot;&quot; Returns True if this game was a victory for the user &quot;&quot;&quot;</span>
<a name="l00194"></a>00194     <span class="keywordflow">return</span> ((self.<a class="code" href="classgamemodel_1_1_game.html#a7176ec1e9d8c2493c12ee92a1a132e6f">victor</a> == 1 <span class="keywordflow">and</span> self.<a class="code" href="classgamemodel_1_1_game.html#af7358b6e0c290bb81c27a433b2f18c5f">player1</a> == user) <span class="keywordflow">or</span> 
<a name="l00195"></a>00195             (self.<a class="code" href="classgamemodel_1_1_game.html#a7176ec1e9d8c2493c12ee92a1a132e6f">victor</a> == 2 <span class="keywordflow">and</span> self.<a class="code" href="classgamemodel_1_1_game.html#a46570b6dbd96a0a2855b9140af8a4edd">player2</a> == user))
<a name="l00196"></a>00196 
<a name="l00197"></a><a class="code" href="classgamemodel_1_1_game.html#a36aded279cf04e48d73b1ed71fe7aee8">00197</a>   <span class="keyword">def </span><a class="code" href="classgamemodel_1_1_game.html#a36aded279cf04e48d73b1ed71fe7aee8">is_loss</a>(self, user):
<a name="l00198"></a>00198     <span class="stringliteral">&quot;&quot;&quot; Returns True if this game was a loss for the user &quot;&quot;&quot;</span>
<a name="l00199"></a>00199     <span class="keywordflow">return</span> ((self.<a class="code" href="classgamemodel_1_1_game.html#a7176ec1e9d8c2493c12ee92a1a132e6f">victor</a> == 1 <span class="keywordflow">and</span> self.<a class="code" href="classgamemodel_1_1_game.html#a46570b6dbd96a0a2855b9140af8a4edd">player2</a> == user) <span class="keywordflow">or</span> 
<a name="l00200"></a>00200             (self.<a class="code" href="classgamemodel_1_1_game.html#a7176ec1e9d8c2493c12ee92a1a132e6f">victor</a> == 2 <span class="keywordflow">and</span> self.<a class="code" href="classgamemodel_1_1_game.html#af7358b6e0c290bb81c27a433b2f18c5f">player1</a> == user))
<a name="l00201"></a>00201 
<a name="l00202"></a><a class="code" href="classgamemodel_1_1_game.html#a2186f09a381bb87968495203dce889d7">00202</a>   <span class="keyword">def </span><a class="code" href="classgamemodel_1_1_game.html#a2186f09a381bb87968495203dce889d7">whose_turn</a>(self):
<a name="l00203"></a>00203     <span class="stringliteral">&quot;&quot;&quot; Returns WHITE (0) or BLACK (1) depending on whose turn it is</span>
<a name="l00204"></a>00204 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00205"></a>00205     <span class="comment"># If there&apos;s been 0, 2, 4, 6 moves, it&apos;s white&apos;s turn, otherwise black</span>
<a name="l00206"></a>00206     <span class="keywordflow">return</span> len(self.<a class="code" href="classgamemodel_1_1_game.html#a274420c1f69b6ebcc1de1fadee5ff023">game_data</a>) % 2
<a name="l00207"></a>00207 
<a name="l00208"></a><a class="code" href="classgamemodel_1_1_game.html#ab8c6983cf85325073b49062ef9b9ab65">00208</a>   <span class="keyword">def </span><a class="code" href="classgamemodel_1_1_game.html#ab8c6983cf85325073b49062ef9b9ab65">is_duplicate_move</a>(self, move):
<a name="l00209"></a>00209     <span class="stringliteral">&quot;&quot;&quot; Returns true if the passed move was the last move taken</span>
<a name="l00210"></a>00210 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00211"></a>00211     <span class="keywordflow">return</span> self.<a class="code" href="classgamemodel_1_1_game.html#a274420c1f69b6ebcc1de1fadee5ff023">game_data</a> <span class="keywordflow">and</span> self.<a class="code" href="classgamemodel_1_1_game.html#a274420c1f69b6ebcc1de1fadee5ff023">game_data</a>[-1] == move
<a name="l00212"></a>00212 
<a name="l00213"></a><a class="code" href="classgamemodel_1_1_game.html#a69a72fb4fc247ac5cdc03e8345c413b4">00213</a>   <span class="keyword">def </span><a class="code" href="classgamemodel_1_1_game.html#a69a72fb4fc247ac5cdc03e8345c413b4">set_time_for_user</a>(self, user, timer):
<a name="l00214"></a>00214     <span class="stringliteral">&quot;&quot;&quot; Sets the time remaining for the user &quot;&quot;&quot;</span>
<a name="l00215"></a>00215     <span class="keywordflow">if</span> user == self.<a class="code" href="classgamemodel_1_1_game.html#af7358b6e0c290bb81c27a433b2f18c5f">player1</a>:
<a name="l00216"></a>00216       self.<a class="code" href="classgamemodel_1_1_game.html#affbe058762ace7df766dcac5270832d8">player1_time</a> = min(self.<a class="code" href="classgamemodel_1_1_game.html#affbe058762ace7df766dcac5270832d8">player1_time</a>, timer)
<a name="l00217"></a>00217     <span class="keywordflow">else</span>:
<a name="l00218"></a>00218       self.<a class="code" href="classgamemodel_1_1_game.html#a21575be4fd330e198955fe7c0f1803cf">player2_time</a> = min(self.<a class="code" href="classgamemodel_1_1_game.html#a21575be4fd330e198955fe7c0f1803cf">player2_time</a>, timer)
<a name="l00219"></a>00219 
<a name="l00220"></a>00220     <span class="comment"># Check for expired timer</span>
<a name="l00221"></a>00221     <span class="keywordflow">if</span> timer &lt;= 0:
<a name="l00222"></a>00222       self.<a class="code" href="classgamemodel_1_1_game.html#ad7843c85abee4764c9e717a8db8cb3a5">status</a> = GAME_STATUS_COMPLETE
<a name="l00223"></a>00223       <span class="keywordflow">if</span> user == self.<a class="code" href="classgamemodel_1_1_game.html#af7358b6e0c290bb81c27a433b2f18c5f">player1</a>:
<a name="l00224"></a>00224         <span class="comment"># Player 1 lost by time</span>
<a name="l00225"></a>00225         self.<a class="code" href="classgamemodel_1_1_game.html#a7176ec1e9d8c2493c12ee92a1a132e6f">victor</a> = 2
<a name="l00226"></a>00226       <span class="keywordflow">else</span>:
<a name="l00227"></a>00227         <span class="comment"># Player 2 lost by time</span>
<a name="l00228"></a>00228         self.<a class="code" href="classgamemodel_1_1_game.html#a7176ec1e9d8c2493c12ee92a1a132e6f">victor</a> = 1
<a name="l00229"></a>00229 
<a name="l00230"></a>00230   <span class="keyword">def </span>join(self, user):
<a name="l00231"></a>00231     <span class="comment"># User is joining a game - make sure it&apos;s an open game, or the user</span>
<a name="l00232"></a>00232     <span class="comment"># is the one who was invited</span>
<a name="l00233"></a>00233     <span class="keywordflow">return</span> db.run_in_transaction(txn_join, self.key(), user)
<a name="l00234"></a>00234 
<a name="l00235"></a>00235   <span class="keyword">def </span>get_outcome_as_string(self):
<a name="l00236"></a>00236     <span class="comment"># Returns a string saying whether the user won/lost/drew</span>
<a name="l00237"></a>00237     user = users.GetCurrentUser()
<a name="l00238"></a>00238     <span class="keywordflow">if</span> self.<a class="code" href="classgamemodel_1_1_game.html#a427144263b022aff6d184fa3ae8a8e31">is_victory</a>(user):
<a name="l00239"></a>00239       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Won&quot;</span>
<a name="l00240"></a>00240     <span class="keywordflow">elif</span> self.<a class="code" href="classgamemodel_1_1_game.html#a36aded279cf04e48d73b1ed71fe7aee8">is_loss</a>(user):
<a name="l00241"></a>00241       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Lost&quot;</span>
<a name="l00242"></a>00242     <span class="keywordflow">else</span>:
<a name="l00243"></a>00243       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Draw&quot;</span>
<a name="l00244"></a>00244 
<a name="l00245"></a>00245 <span class="keyword">def </span>txn_join(key, user):
<a name="l00246"></a>00246   <span class="stringliteral">&quot;&quot;&quot; Adds the user to a game, if he was the invitee &quot;&quot;&quot;</span>
<a name="l00247"></a>00247   gameObj = Game.get(key)
<a name="l00248"></a>00248   <span class="keywordflow">if</span> <span class="keywordflow">not</span> gameObj.invitee <span class="keywordflow">or</span> user.email() == gameObj.invitee:
<a name="l00249"></a>00249     <span class="keywordflow">if</span> gameObj.status != GAME_STATUS_COMPLETE:
<a name="l00250"></a>00250       gameObj.player2 = user
<a name="l00251"></a>00251       gameObj.status = GAME_STATUS_ACTIVE
<a name="l00252"></a>00252       gameObj.put()
<a name="l00253"></a>00253       <span class="keywordflow">return</span> <span class="keyword">True</span>
<a name="l00254"></a>00254   <span class="keywordflow">return</span> <span class="keyword">False</span>
<a name="l00255"></a>00255 
<a name="l00256"></a>00256 <span class="keyword">def </span>txn_update(key, user, move, timer, victor):
<a name="l00257"></a>00257   <span class="stringliteral">&quot;&quot;&quot; Updates a game object within the context of a transaction for </span>
<a name="l00258"></a>00258 <span class="stringliteral">      atomicity, after checking for validity. Returns True if the data was </span>
<a name="l00259"></a>00259 <span class="stringliteral">      saved.</span>
<a name="l00260"></a>00260 <span class="stringliteral">  &quot;&quot;&quot;</span>
<a name="l00261"></a>00261   gameObj = Game.get(key)
<a name="l00262"></a>00262   <span class="keywordflow">if</span> gameObj.status != GAME_STATUS_ACTIVE:
<a name="l00263"></a>00263     <span class="comment"># Can only modify active games</span>
<a name="l00264"></a>00264     <span class="keywordflow">return</span> <span class="keyword">False</span>
<a name="l00265"></a>00265   <span class="keywordflow">elif</span> gameObj.whose_turn() == gameObj.get_user_color(user):
<a name="l00266"></a>00266     <span class="comment"># It&apos;s our turn, add the move</span>
<a name="l00267"></a>00267     <span class="keywordflow">if</span> move != <span class="keywordtype">None</span>:
<a name="l00268"></a>00268       gameObj.game_data.append(move)
<a name="l00269"></a>00269     <span class="keywordflow">if</span> timer != <span class="keywordtype">None</span>:
<a name="l00270"></a>00270       gameObj.set_time_for_user(user, timer)
<a name="l00271"></a>00271     <span class="keywordflow">if</span> victor != <span class="keywordtype">None</span>:
<a name="l00272"></a>00272       gameObj.victor = victor
<a name="l00273"></a>00273       gameObj.status = GAME_STATUS_COMPLETE
<a name="l00274"></a>00274     gameObj.put()
<a name="l00275"></a>00275     <span class="keywordflow">return</span> <span class="keyword">True</span>
<a name="l00276"></a>00276   <span class="keywordflow">elif</span> move:
<a name="l00277"></a>00277     <span class="comment"># Not our turn, but don&apos;t return an error if it&apos;s a duplicate of the last </span>
<a name="l00278"></a>00278     <span class="comment"># one (it just means the client sent it twice due to a network hiccup)</span>
<a name="l00279"></a>00279     <span class="keywordflow">return</span> gameObj.is_duplicate_move(move)
<a name="l00280"></a>00280   <span class="keywordflow">else</span>:
<a name="l00281"></a>00281     <span class="keywordflow">return</span> <span class="keyword">False</span>
<a name="l00282"></a>00282 
<a name="l00283"></a>00283 
<a name="l00284"></a>00284 <span class="comment"># The color of player 1&apos;s pieces</span>
<a name="l00285"></a>00285 WHITE = 0
<a name="l00286"></a>00286 BLACK = 1  
<a name="l00287"></a>00287 
<a name="l00288"></a>00288 <span class="comment"># An open game (anyone can join)</span>
<a name="l00289"></a>00289 GAME_STATUS_OPEN = 0
<a name="l00290"></a>00290 
<a name="l00291"></a>00291 <span class="comment"># A game with a specific invitee - the invite has been issued, but not accepted</span>
<a name="l00292"></a>00292 <span class="comment"># yet</span>
<a name="l00293"></a>00293 GAME_STATUS_INVITED = 1
<a name="l00294"></a>00294 
<a name="l00295"></a>00295 <span class="comment"># The game is in progress</span>
<a name="l00296"></a>00296 GAME_STATUS_ACTIVE = 2
<a name="l00297"></a>00297 
<a name="l00298"></a>00298 <span class="comment"># The game is over</span>
<a name="l00299"></a>00299 GAME_STATUS_COMPLETE = 3
<a name="l00300"></a>00300 
<a name="l00301"></a>00301 GAME_TYPE_CHESS = <span class="stringliteral">&quot;chess&quot;</span>
<a name="l00302"></a>00302 GAME_TYPE_BLITZ_5 = <span class="stringliteral">&quot;blitz-5&quot;</span>
<a name="l00303"></a>00303 GAME_TYPE_BLITZ_10 = <span class="stringliteral">&quot;blitz-10&quot;</span>
<a name="l00304"></a>00304 
<a name="l00305"></a>00305 <span class="keyword">def </span>public_game_list():
<a name="l00306"></a>00306   <span class="stringliteral">&quot;&quot;&quot; Returns a list of open and public active games</span>
<a name="l00307"></a>00307 <span class="stringliteral">  &quot;&quot;&quot;</span>
<a name="l00308"></a>00308   games = Game.gql(<span class="stringliteral">&quot;WHERE status = :status&quot;</span> 
<a name="l00309"></a>00309                    <span class="stringliteral">&quot; ORDER BY last_modified DESC LIMIT 25&quot;</span>,
<a name="l00310"></a>00310                    status=GAME_STATUS_OPEN)
<a name="l00311"></a>00311   
<a name="l00312"></a>00312   games2 = Game.gql(<span class="stringliteral">&quot;WHERE status = :status AND public=:public&quot;</span>
<a name="l00313"></a>00313                     <span class="stringliteral">&quot; ORDER BY last_modified DESC LIMIT 25&quot;</span>,
<a name="l00314"></a>00314                     status=GAME_STATUS_ACTIVE, public=<span class="keyword">True</span>)
<a name="l00315"></a>00315   <span class="keywordflow">return</span> filter(filter_expired_games, list(games) + list(games2))
<a name="l00316"></a>00316 
<a name="l00317"></a>00317   
<a name="l00318"></a>00318 <span class="keyword">def </span>games_by_user_list(user):
<a name="l00319"></a>00319   <span class="stringliteral">&quot;&quot;&quot; Returns a list of non-completed games that involve this user. Have to do</span>
<a name="l00320"></a>00320 <span class="stringliteral">      two separate queries, since we can&apos;t query either player1 OR player2</span>
<a name="l00321"></a>00321 <span class="stringliteral">  &quot;&quot;&quot;</span>
<a name="l00322"></a>00322   games = Game.gql(<span class="stringliteral">&quot;WHERE player1 = :user AND status &lt; :status&quot;</span>,
<a name="l00323"></a>00323                     user=user, status=GAME_STATUS_COMPLETE)
<a name="l00324"></a>00324   games2 = Game.gql(<span class="stringliteral">&quot;WHERE player2 = :user AND status &lt; :status&quot;</span>,
<a name="l00325"></a>00325                     user=user, status=GAME_STATUS_COMPLETE)
<a name="l00326"></a>00326   result = filter(filter_expired_games, list(games) + list(games2))
<a name="l00327"></a>00327   result.sort(key=<span class="keyword">lambda</span> obj:obj.last_modified, reverse=<span class="keyword">True</span>)
<a name="l00328"></a>00328   <span class="keywordflow">return</span> result
<a name="l00329"></a>00329   
<a name="l00330"></a>00330 <span class="keyword">def </span>completed_games_list(user):
<a name="l00331"></a>00331   <span class="stringliteral">&quot;&quot;&quot; Returns a list of finished games that involve this user &quot;&quot;&quot;</span>
<a name="l00332"></a>00332   games = Game.gql(<span class="stringliteral">&quot;WHERE player1 = :user AND status = :status&quot;</span>
<a name="l00333"></a>00333                    <span class="stringliteral">&quot; ORDER BY last_modified DESC&quot;</span>, 
<a name="l00334"></a>00334                     user=user, status=GAME_STATUS_COMPLETE)
<a name="l00335"></a>00335   games2 = Game.gql(<span class="stringliteral">&quot;WHERE player2 = :user AND status = :status&quot;</span>
<a name="l00336"></a>00336                     <span class="stringliteral">&quot; ORDER BY last_modified DESC&quot;</span>, 
<a name="l00337"></a>00337                     user=user, status=GAME_STATUS_COMPLETE)
<a name="l00338"></a>00338   result = list(games) + list(games2)
<a name="l00339"></a>00339   result.sort(key=<span class="keyword">lambda</span> obj:obj.last_modified, reverse=<span class="keyword">True</span>)
<a name="l00340"></a>00340   <span class="keywordflow">return</span> result
<a name="l00341"></a>00341 
<a name="l00342"></a>00342 <span class="keyword">def </span>relative_string(elapsed):
<a name="l00343"></a>00343   <span class="stringliteral">&quot;&quot;&quot; Takes a time delta and expresses it as a relative string &quot;&quot;&quot;</span>
<a name="l00344"></a>00344   <span class="keywordflow">if</span> elapsed &lt; 2 * 60:
<a name="l00345"></a>00345     result = <span class="stringliteral">&quot;1 minute ago&quot;</span>
<a name="l00346"></a>00346   <span class="keywordflow">elif</span> elapsed &lt; 60*60:
<a name="l00347"></a>00347     result = <span class="stringliteral">&quot;%d minutes ago&quot;</span> % (elapsed/60)
<a name="l00348"></a>00348   <span class="keywordflow">elif</span> elapsed &lt; 2 * 60 * 60:
<a name="l00349"></a>00349     result = <span class="stringliteral">&quot;1 hour ago&quot;</span>
<a name="l00350"></a>00350   <span class="keywordflow">elif</span> elapsed &lt; 24 * 60 * 60:
<a name="l00351"></a>00351     result = <span class="stringliteral">&quot;%d hours ago&quot;</span> % (elapsed/(60*60))
<a name="l00352"></a>00352   <span class="keywordflow">elif</span> elapsed &lt; 48 * 60 * 60:
<a name="l00353"></a>00353     result = <span class="stringliteral">&quot;1 day ago&quot;</span>
<a name="l00354"></a>00354   <span class="keywordflow">else</span>:
<a name="l00355"></a>00355     result = <span class="stringliteral">&quot;%d days ago&quot;</span> % (elapsed/(24 * 60 * 60))
<a name="l00356"></a>00356   <span class="keywordflow">return</span> result
<a name="l00357"></a>00357 
<a name="l00358"></a>00358 <span class="comment"># Timed games expire after the user&apos;s timer has run out + 2 minutes</span>
<a name="l00359"></a>00359 TIMED_GAME_BUFFER = 60*2
<a name="l00360"></a>00360 
<a name="l00361"></a>00361 <span class="comment"># Abandoned games (games with no moves) get deleted after a week</span>
<a name="l00362"></a>00362 ABANDONED_GAME_DURATION = 60 * 24 * 7
<a name="l00363"></a>00363 
<a name="l00364"></a>00364 <span class="comment"># Open timed games expire after 15 minutes</span>
<a name="l00365"></a>00365 OPEN_GAME_EXPIRATION = 60 * 15
<a name="l00366"></a>00366 
<a name="l00367"></a>00367 <span class="comment"># After 4 moves, abandoned games count as a loss</span>
<a name="l00368"></a>00368 MAX_MOVES_FOR_DELETION = 4
<a name="l00369"></a>00369 
<a name="l00370"></a>00370 <span class="keyword">def </span>filter_expired_games(gameObj):
<a name="l00371"></a>00371   <span class="stringliteral">&quot;&quot;&quot; Checks the date of the game - if it is expired, deletes it and returns</span>
<a name="l00372"></a>00372 <span class="stringliteral">      false.</span>
<a name="l00373"></a>00373 <span class="stringliteral">  &quot;&quot;&quot;</span>
<a name="l00374"></a>00374   elapsed = time.time() - time.mktime(gameObj.last_modified.timetuple())
<a name="l00375"></a>00375   <span class="comment"># Games with no moves expire after a week</span>
<a name="l00376"></a>00376   <span class="keywordflow">if</span> ((<span class="keywordflow">not</span> gameObj.game_data <span class="keywordflow">or</span> (len(gameObj.game_data) == 0)) <span class="keywordflow">and</span>
<a name="l00377"></a>00377       (elapsed &gt;= ABANDONED_GAME_DURATION)):
<a name="l00378"></a>00378     gameObj.delete()
<a name="l00379"></a>00379     <span class="keywordflow">return</span> <span class="keyword">False</span>
<a name="l00380"></a>00380     
<a name="l00381"></a>00381   <span class="comment"># Untimed games don&apos;t expire currently</span>
<a name="l00382"></a>00382   <span class="keywordflow">if</span> gameObj.game_type == GAME_TYPE_CHESS:
<a name="l00383"></a>00383     <span class="keywordflow">return</span> <span class="keyword">True</span>
<a name="l00384"></a>00384   
<a name="l00385"></a>00385   <span class="comment"># OK, we&apos;re a timed game. If we&apos;re an open game (nobody has joined yet) we</span>
<a name="l00386"></a>00386   <span class="comment"># expire after 15 minutes. </span>
<a name="l00387"></a>00387   <span class="keywordflow">if</span> gameObj.status == GAME_STATUS_OPEN: 
<a name="l00388"></a>00388     <span class="keywordflow">if</span> elapsed &gt; OPEN_GAME_EXPIRATION:
<a name="l00389"></a>00389       gameObj.delete()
<a name="l00390"></a>00390       <span class="keywordflow">return</span> <span class="keyword">False</span>
<a name="l00391"></a>00391     <span class="keywordflow">else</span>:
<a name="l00392"></a>00392       <span class="keywordflow">return</span> <span class="keyword">True</span>
<a name="l00393"></a>00393   
<a name="l00394"></a>00394   <span class="comment"># OK, there are moves in this game. Calculate whose turn it is, how long since</span>
<a name="l00395"></a>00395   <span class="comment"># their last move, and whether the game should be over or not. This is </span>
<a name="l00396"></a>00396   <span class="comment"># slightly dangerous since games could be prematurely ended if the times on</span>
<a name="l00397"></a>00397   <span class="comment"># the servers are out of sync, so we give the user a couple of minutes of</span>
<a name="l00398"></a>00398   <span class="comment"># leeway before terminating it.</span>
<a name="l00399"></a>00399   <span class="keywordflow">if</span> gameObj.whose_turn() == gameObj.player1_color:
<a name="l00400"></a>00400     remaining = gameObj.player1_time
<a name="l00401"></a>00401   <span class="keywordflow">else</span>:
<a name="l00402"></a>00402     remaining = gameObj.player2_time
<a name="l00403"></a>00403   <span class="keywordflow">if</span> elapsed &lt; (remaining/1000 + TIMED_GAME_BUFFER):
<a name="l00404"></a>00404     <span class="comment"># Game hasn&apos;t expired yet</span>
<a name="l00405"></a>00405     <span class="keywordflow">return</span> <span class="keyword">True</span>
<a name="l00406"></a>00406 
<a name="l00407"></a>00407   <span class="comment"># OK, this game is expiring - if the game only has a few moves, we&apos;ll just</span>
<a name="l00408"></a>00408   <span class="comment"># delete it. Otherwise, we&apos;ll force a timeout for the player who abandoned</span>
<a name="l00409"></a>00409   <span class="comment"># it.</span>
<a name="l00410"></a>00410   <span class="keywordflow">if</span> gameObj.game_data <span class="keywordflow">and</span> (len(gameObj.game_data) &gt; MAX_MOVES_FOR_DELETION):
<a name="l00411"></a>00411     turn = gameObj.whose_turn()
<a name="l00412"></a>00412     <span class="keywordflow">if</span> turn == gameObj.player1_color:
<a name="l00413"></a>00413       <span class="comment"># player 1 must lose</span>
<a name="l00414"></a>00414       loser = gameObj.player1
<a name="l00415"></a>00415     <span class="keywordflow">else</span>:
<a name="l00416"></a>00416       loser = gameObj.player2
<a name="l00417"></a>00417     <span class="comment"># Set the time as expired for the poor loser</span>
<a name="l00418"></a>00418     gameObj.update(loser, timer=0)
<a name="l00419"></a>00419   <span class="keywordflow">else</span>:
<a name="l00420"></a>00420     gameObj.delete()
<a name="l00421"></a>00421   <span class="keywordflow">return</span> <span class="keyword">False</span>
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Functions</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on 1 Nov 2011 for blitzpython by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
